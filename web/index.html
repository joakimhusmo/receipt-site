<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Art Receipt Printer</title>
    <link rel="stylesheet" href="/style.css">
  </head>

  <body>
    <h1>Type &amp; Print</h1>

    <label for="msg">Message</label>
    <input id="msg" autocomplete="off" />

    <div class="row">
      <button id="btnCustom">Print (custom font)</button>
    </div>

    <div id="status" aria-live="polite"></div>

    <script>
      // ===== Tunables for layout on the 80mm roll =====
      let FONT_SIZE = 84;      // adjust if you want bigger/smaller glyphs
      let LINE = 90;           // vertical spacing between lines
      const W = 576;           // print width in dots (≈80mm printers)
      const PADDING = 24;

      // Cloud routing
      const LOCATION_ID = "oslo-gallery-1";
      const API_BASE = "";     // same origin (Render service)

      // UI
      const statusEl = document.getElementById("status");
      const msgEl = document.getElementById("msg");
      const btnCustom = document.getElementById("btnCustom");
      const setOk  = (m) => { statusEl.textContent = m; statusEl.className = "ok"; };
      const setErr = (m) => { statusEl.textContent = m; statusEl.className = "err"; };

      // ---------- Print using the custom font (render to PNG) ----------
      btnCustom.onclick = async () => {
        try {
          const toPrint = String(msgEl.value ?? "");
          if (!toPrint.trim()) { setErr("Empty text"); return; }

          const png = await textToPngDataURL(toPrint);

          const r = await fetch(`${API_BASE}/print/${encodeURIComponent(LOCATION_ID)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ png })
          });

          const j = await r.json();
          j.ok ? setOk("Printed (custom font) ✅") : setErr("Error: " + j.error);
        } catch (e) {
          setErr("Error: " + e);
        }
      };

      // ---------- Canvas helpers ----------
      async function makeHorizontalCanvas(text) {
        await document.fonts.ready;
        const FONT = `bold ${FONT_SIZE}px NewFont`;

        // measure/wrap
        const m = document.createElement("canvas").getContext("2d");
        m.font = FONT;

        const words = (text || "").split(/\s+/);
        const lines = [];
        let line = "";

        for (const w of words) {
          const t = line ? line + " " + w : w;
          if (m.measureText(t).width > (W - PADDING * 2)) {
            if (line) lines.push(line);
            line = w;
          } else {
            line = t;
          }
        }
        if (line) lines.push(line);

        // paint
        const H = PADDING + Math.max(1, lines.length) * LINE + PADDING;
        const c = document.createElement("canvas");
        c.width = W;
        c.height = H;

        const ctx = c.getContext("2d");
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, W, H);
        ctx.fillStyle = "#000"; ctx.font = FONT; ctx.textBaseline = "top";

        let y = PADDING;
        for (const l of lines) {
          const w = ctx.measureText(l).width;
          const x = (W - w) / 2;          // centered
          ctx.fillText(l, x, y);
          y += LINE;
        }

        return c;
      }

      async function textToPngDataURL(text) {
        const c = await makeHorizontalCanvas(text);
        return c.toDataURL("image/png");
      }
    </script>
  </body>
</html>